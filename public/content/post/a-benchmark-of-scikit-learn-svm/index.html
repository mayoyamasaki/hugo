
<!DOCTYPE html>
<html lang="ja">
<head>

  
  <meta charset="UTF-8">
  <title>
    A Benchmark of scikit-learn SVMs | Mayo&#39;s Blog
  </title>


  
  <meta name="viewport" content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1">

  
  <link rel="canonical" href="https://mayoyamasaki.github.io/content/post/a-benchmark-of-scikit-learn-svm/"/>

  
  <link rel="stylesheet" href="/css/sanitize.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/highlight_monokai.css">
  <link rel="stylesheet" href="/css/theme.css">
  <link rel="stylesheet" href="/css/custom.css">
  
  
  <link href="https://mayoyamasaki.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Mayo&#39;s Blog" />
  <link href="https://mayoyamasaki.github.io/index.xml" rel="feed" type="application/rss+xml" title="Mayo&#39;s Blog" />

  
  


</head>



<body>
<div class="container">

  
  <header role="banner">
    <div class="row gutters">
      <div id="site-title" class="col span_6">
        <h1><a href="https://mayoyamasaki.github.io/">Mayo&#39;s Blog</a></h1>
        
      </div>
      <div id="social" class="col span_6">
        <ul>
          <li><a href="https://twitter.com/mayoyamasaki" target="_blank">Twitter</a></li>
          
          <li><a href="https://github.com/mayoyamasaki" target="_blank">GitHub</a></li>
          <li><a href="https://mayoyamasaki.github.io/index.xml" type="application/rss+xml" target="_blank">RSS</a></li>
        </ul>
      </div>
    </div>
  </header>


  
  <main id="single" role="main">
    <div class="article-header">
      <h1>A Benchmark of scikit-learn SVMs</h1>
      <div class="meta">
        Nov 12, 2016 &nbsp;
        
          #<a href="/tags/ml">ML</a>&nbsp;
        
          #<a href="/tags/python">Python</a>&nbsp;
        
      </div>
    </div>
    <article>
      

<h2 id="概要">概要</h2>

<ul>
<li>Baggingと多項式カーネルを使ったSVMが、精度と学習及び予測速度の観点で、良さそうであった。</li>
</ul>

<h2 id="はじめに">はじめに</h2>

<p>あるシステムの実行速度が遅く、プロファイルしてみたところ、SVMがボトルネックになっていた。
他の処理(別の学習器も含む)と比較しても数十〜数百倍、学習と推定が遅かったので、<a href="http://scikit-learn.org/stable/">scikit-learn</a>のSVMのベンチマークを取ってみた。</p>

<h2 id="設定">設定</h2>

<ul>
<li>SVM実装は、SVC(rbf, poly), LinearSVCを使用した。</li>
<li>OneVsRestの多クラス分類で、irisデータセットを使用した。</li>
<li>それぞれについて、BaggingClassifierを使ったアンサンブルを試した。</li>
<li>ついでに、RandomForestClassifierも試した。</li>
</ul>

<h2 id="実装">実装</h2>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">time</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">collections</span> <span style="color: #008000; font-weight: bold">import</span> defaultdict
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">itertools</span> <span style="color: #008000; font-weight: bold">import</span> cycle

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">sklearn.ensemble</span> <span style="color: #008000; font-weight: bold">import</span> BaggingClassifier
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">sklearn.ensemble</span> <span style="color: #008000; font-weight: bold">import</span> RandomForestClassifier
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">sklearn</span> <span style="color: #008000; font-weight: bold">import</span> datasets
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">sklearn.multiclass</span> <span style="color: #008000; font-weight: bold">import</span> OneVsRestClassifier
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">sklearn.svm</span> <span style="color: #008000; font-weight: bold">import</span> SVC
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">sklearn.svm</span> <span style="color: #008000; font-weight: bold">import</span> LinearSVC
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">sklearn.metrics</span> <span style="color: #008000; font-weight: bold">import</span> f1_score
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">sklearn.model_selection</span> <span style="color: #008000; font-weight: bold">import</span> train_test_split


<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">load_dataset</span>():
    X, y <span style="color: #666666">=</span> datasets<span style="color: #666666">.</span>load_iris(return_X_y<span style="color: #666666">=</span><span style="color: #008000">True</span>)
    X <span style="color: #666666">=</span> np<span style="color: #666666">.</span>repeat(X, <span style="color: #666666">300</span>, axis<span style="color: #666666">=0</span>)
    y <span style="color: #666666">=</span> np<span style="color: #666666">.</span>repeat(y, <span style="color: #666666">300</span>, axis<span style="color: #666666">=0</span>)
    <span style="color: #008000; font-weight: bold">return</span> X, y


<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">timeit</span>(func, args):
    start <span style="color: #666666">=</span> time<span style="color: #666666">.</span>clock()
    results <span style="color: #666666">=</span> func(<span style="color: #666666">*</span>args)
    end <span style="color: #666666">=</span> time<span style="color: #666666">.</span>clock()
    <span style="color: #008000; font-weight: bold">return</span> results, end<span style="color: #666666">-</span>start


<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">make_clfs</span>():
    classifiers <span style="color: #666666">=</span> []
    SVCs <span style="color: #666666">=</span> (
        (SVC(kernel<span style="color: #666666">=</span><span style="color: #BA2121">&#39;linear&#39;</span>), <span style="color: #BA2121">&#39;SVC,linear&#39;</span>),
        (SVC(kernel<span style="color: #666666">=</span><span style="color: #BA2121">&#39;rbf&#39;</span>), <span style="color: #BA2121">&#39;SVC,rbf&#39;</span>),
        (SVC(kernel<span style="color: #666666">=</span><span style="color: #BA2121">&#39;poly&#39;</span>), <span style="color: #BA2121">&#39;SVC,poly&#39;</span>),
    )
    classifiers<span style="color: #666666">.</span>extend(
        [(OneVsRestClassifier(estimater), <span style="color: #BA2121">&#39;OvR&#39;</span><span style="color: #666666">+</span>title)
            <span style="color: #008000; font-weight: bold">for</span> estimater,title <span style="color: #AA22FF; font-weight: bold">in</span> SVCs])
    classifiers<span style="color: #666666">.</span>extend(
        [(OneVsRestClassifier(
            BaggingClassifier(estimater, max_samples<span style="color: #666666">=0.1</span>)), <span style="color: #BA2121">&#39;OvR,Bagging,&#39;</span><span style="color: #666666">+</span>title)
                <span style="color: #008000; font-weight: bold">for</span> estimater,title <span style="color: #AA22FF; font-weight: bold">in</span> SVCs])
    classifiers<span style="color: #666666">.</span>append((LinearSVC(), <span style="color: #BA2121">&#39;LinearSVC&#39;</span>))
    classifiers<span style="color: #666666">.</span>append((RandomForestClassifier(), <span style="color: #BA2121">&#39;RandomForest&#39;</span>))
    <span style="color: #008000; font-weight: bold">return</span> classifiers


<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">sample</span>(X, y, train_size):
    <span style="color: #008000; font-weight: bold">if</span> train_size <span style="color: #666666">==</span> <span style="color: #666666">1.</span>: <span style="color: #008000; font-weight: bold">return</span> X, y
    _X, _, _y, _  <span style="color: #666666">=</span> train_test_split(X, y, train_size<span style="color: #666666">=</span>train_size, random_state<span style="color: #666666">=0</span>)
    <span style="color: #008000; font-weight: bold">return</span> _X, _y


<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">plot</span>(graph_title, train_sizes, dic):
    colors <span style="color: #666666">=</span> cycle([<span style="color: #BA2121">&#39;b&#39;</span>, <span style="color: #BA2121">&#39;g&#39;</span>, <span style="color: #BA2121">&#39;r&#39;</span>, <span style="color: #BA2121">&#39;c&#39;</span>, <span style="color: #BA2121">&#39;m&#39;</span>, <span style="color: #BA2121">&#39;y&#39;</span>, <span style="color: #BA2121">&#39;k&#39;</span>, <span style="color: #BA2121">&#39;w&#39;</span>])
    plt<span style="color: #666666">.</span>figure()
    plt<span style="color: #666666">.</span>title(graph_title)
    plt<span style="color: #666666">.</span>xlabel(<span style="color: #BA2121">&quot;Training examples&quot;</span>)
    plt<span style="color: #666666">.</span>ylabel(graph_title)
    plt<span style="color: #666666">.</span>grid()

    <span style="color: #008000; font-weight: bold">for</span> label, vals <span style="color: #AA22FF; font-weight: bold">in</span> dic<span style="color: #666666">.</span>items():
        plt<span style="color: #666666">.</span>plot(train_sizes, vals, <span style="color: #BA2121">&#39;o-&#39;</span>, color<span style="color: #666666">=</span><span style="color: #008000">next</span>(colors), label<span style="color: #666666">=</span>label)
    plt<span style="color: #666666">.</span>legend(loc<span style="color: #666666">=</span><span style="color: #BA2121">&quot;best&quot;</span>)
    <span style="color: #008000; font-weight: bold">return</span> plt


<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>():
    CV<span style="color: #666666">=5</span>
    X, y <span style="color: #666666">=</span> load_dataset()
    classifiers <span style="color: #666666">=</span> make_clfs()
    train_sizes <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linspace(<span style="color: #666666">.1</span>, <span style="color: #666666">1.</span>, <span style="color: #666666">5</span>)
    fit_times <span style="color: #666666">=</span> defaultdict(<span style="color: #008000">list</span>)
    pred_times <span style="color: #666666">=</span> defaultdict(<span style="color: #008000">list</span>)
    fscores <span style="color: #666666">=</span> defaultdict(<span style="color: #008000">list</span>)

    <span style="color: #008000; font-weight: bold">for</span> train_size <span style="color: #AA22FF; font-weight: bold">in</span> train_sizes:
        _X, _y <span style="color: #666666">=</span> sample(X, y, train_size)
        <span style="color: #008000; font-weight: bold">for</span> clf, title <span style="color: #AA22FF; font-weight: bold">in</span> classifiers:
            scores <span style="color: #666666">=</span> {<span style="color: #BA2121">&#39;fit&#39;</span>:[], <span style="color: #BA2121">&#39;pred&#39;</span>:[], <span style="color: #BA2121">&#39;fscore&#39;</span>:[] }
            <span style="color: #008000; font-weight: bold">for</span> n_cv <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(CV):
                X_train, X_test, y_train, y_test <span style="color: #666666">=</span> train_test_split(
                    _X, _y, test_size<span style="color: #666666">=0.4</span>, random_state<span style="color: #666666">=0</span>)

                _, t <span style="color: #666666">=</span> timeit(clf<span style="color: #666666">.</span>fit, (X_train, y_train))
                scores[<span style="color: #BA2121">&#39;fit&#39;</span>]<span style="color: #666666">.</span>append(t)

                y_pred, t <span style="color: #666666">=</span> timeit(clf<span style="color: #666666">.</span>predict, (X_test, ))
                scores[<span style="color: #BA2121">&#39;pred&#39;</span>]<span style="color: #666666">.</span>append(t)

                fscore <span style="color: #666666">=</span> f1_score(y_test, y_pred, average<span style="color: #666666">=</span><span style="color: #BA2121">&#39;macro&#39;</span>)
                scores[<span style="color: #BA2121">&#39;fscore&#39;</span>]<span style="color: #666666">.</span>append(fscore)

            fit_times[title]<span style="color: #666666">.</span>append(np<span style="color: #666666">.</span>mean(scores[<span style="color: #BA2121">&#39;fit&#39;</span>]))
            pred_times[title]<span style="color: #666666">.</span>append(np<span style="color: #666666">.</span>mean(scores[<span style="color: #BA2121">&#39;pred&#39;</span>]))
            fscores[title]<span style="color: #666666">.</span>append(np<span style="color: #666666">.</span>mean(scores[<span style="color: #BA2121">&#39;fscore&#39;</span>]))

    plot(<span style="color: #BA2121">&#39;Fscores&#39;</span>, train_sizes, fscores)
    plot(<span style="color: #BA2121">&#39;Time of Training&#39;</span>, train_sizes, fit_times)
    plot(<span style="color: #BA2121">&#39;Time of Predication&#39;</span>, train_sizes, pred_times)
    plt<span style="color: #666666">.</span>show()


<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    main()
</pre></div>

<p><code>make_clfs</code>で作成した分類器一つ一つに対して、学習時間、推測時間、F値(マクロ平均)を求めている。
尚、これらの値は5回施行の平均値であり、データ量増加に対する、推移を見ている。</p>

<h2 id="結果">結果</h2>

<h3 id="f値">F値</h3>

<p><img src="/images/a-benchmark-of-scikit-learn-svm/fscores.png" alt="fscores" /></p>

<p>一瞬見失うが、RandomForestの精度が最も高く、非線形カーネル、線形カーネルの順番に精度が高かった。
また、Baggingを加えても非線形カーネルではほとんど差が出ていない。</p>

<h3 id="学習時間">学習時間</h3>

<p><img src="/images/a-benchmark-of-scikit-learn-svm/trains.png" alt="trains" />
多項式カーネルでは、Baggingの効果が顕著にでている。また、SVCの線形カーネルは話に聞く通り低パフォーマンスで、LinearSVCの方が学習時間は少ない。</p>

<blockquote>
<p>単位記述を忘れたが、縦軸は[s]である。</p>
</blockquote>

<h3 id="予測時間">予測時間</h3>

<p><img src="/images/a-benchmark-of-scikit-learn-svm/preds.png" alt="preds" />
予測時間では、一転してBaggingを使用しない方が速度がでている傾向にある。また、推測においてもSVCの線形カーネルのパフォーマンスは低い。</p>

<h2 id="おわりに">おわりに</h2>

<p>この手のベンチマークはデータセットに依存するが、今回の評価では、SVMの中では、Baggingを使った多項式カーネルによるOneVsRestが有効であった。<br />
今回の様に汎化しやすそうなデータセットでは、やはりRandomForestは有効で、今後は、多様なデータセットでの検証をやってみたい。<br />
また、Baggingやアンサンブル学習を初めて試してみたが、実行速度改善に大きく寄与したので、実システムでも試してみたい。尚、Baggingについは、アンサンブル学習のスライドが分かりやすかった<sup class="footnote-ref" id="fnref:1"><a rel="footnote" href="#fn:1">1</a></sup>。</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1"><a href="http://www.slideshare.net/holidayworking/ss-11948523">アンサンブル学習</a>
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
</ol>
</div>

      
      
      
    </article>
    
 <aside><div id="disqus_thread"></div></aside>

<script type="text/javascript">
     
    var disqus_shortname = 'mayoyamasaki';

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



  </main>
  
  <nav class="pagination-single">
    
      <span class="previous">&larr; <a href="https://mayoyamasaki.github.io/content/post/html-to-text-for-nlp/" rel="prev">HTML to TEXT for NLP</a></span>
    
    
      <span class="next"><a href="https://mayoyamasaki.github.io/content/post/introduction-to-neo4j/" rel="next">Introduction to Neo4j</a> &rarr;</span>
    
  </nav>


  
  <footer role="contentinfo">
    <div style="text-align:center;">
      
      Copyright (c) 2016, mayo yamasaki all rights reserved.
    </div>
  </footer>


</div>

<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



</body>
</html>

